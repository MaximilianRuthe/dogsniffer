<!DOCTYPE html>
<!--
    Copyright (c) 2012-2014 Adobe Systems Incorporated. All rights reserved.

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
     KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
-->
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="msapplication-tap-highlight" content="no" />
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />	
		<link rel="stylesheet" href="css/magecast.min.css" />
		<link rel="stylesheet" href="css/jquery.mobile.icons.min.css" />
		<link rel='stylesheet' href='css/jquery.mobile.structure-1.4.5.min.css' type='text/css' media='all' />
		<link rel='stylesheet' href='druid.css' type='text/css' media='all' />
        <title>Dog Sniffer</title>		
		<script type="text/javascript" src="js/jquery.js"></script>
		<script type="text/javascript" src="cordova.js"></script>
		<script type='text/javascript' src='js/jquery.mobile-1.4.5.min.js'></script>		
		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
		<script type='text/javascript' src='js/gmaps.js'></script>
	<script>
var directions;
var page_title;
var map;
var authenticated;
$(document).on('pagebeforeshow', "#single", function (event, data) {
    var parameters = $(this).data("url").split("?")[1];;
    DS.post.id = parameter = parameters.replace("id=",""); 
    DS.singleView(DS.post.id);	
});
$( document ).on( "pagecreate", "#home", function() {
	
	$( "#login" ).enhanceWithin().popup();
	$( "#actions" ).enhanceWithin().popup();
	$( "#open-map" ).flipswitch().flipswitch('refresh');
	DS.setSelect('#opt-category');
	
	var regSwitch = $( "#open-register" ),
        logSwitch = $( "#open-login" ),
		passSwitch = $( "#open-password" ),
		mapSwitch = $( "#open-map" ),
		mapPage = $( "#mage-map" ),
		mapList = $( "#mage-list" ),
        registerForm = $( "#register-form" ),
		passwordForm = $( "#password-form" ),
        loginForm = $( "#login-form" );
	
	mapSwitch.on( "change", function( e ){
		var toggleMap = $('#open-map').val();
		if (toggleMap == 'list'){
			mapPage.show();
			if (DS.nearby === false){
				DS.geo.lat = 34.0544902;
				DS.geo.lng = -118.4413104;
			}
			map = new GMaps({
				div: '#mage-map',
				lat: DS.geo.lat,
				lng: DS.geo.lng,
				disableDefaultUI: true,
				zoom: 15,		
				width: 'auto',
				height: '100%',
				idle: function(){
					map.refresh();
				},
				resize: function(){
					var center = map.getCenter();
					map.setCenter(center.lat(), center.lng());
				}
			});	
			DS.queryMap(DS.query.posts);
       		mapList.hide();
		} else {
			mapList.show();
			mapPage.hide();
		}
		e.preventDefault();
	});
	mapSwitch.on( "click", function( e ){
		
    });
    regSwitch.on( "click", function( e ){
		registerForm.show();
        loginForm.hide();
    });
    logSwitch.on( "click", function( e ){
        loginForm.show();
        registerForm.hide();
    });	
    $( "#show-more a" ).on( "click", function( e ){        
        DS.showMore();
        e.preventDefault();
    });	
 	$( "#research" ).on( "click", function( e ){      
		DS.address.zip = '';
		DS.query.search = '';
		DS.query.term = '';  
		$('#opt-zip').val('');
		$('#s').val('');	
		DS.setSelect('#opt-category','all');
        $( "#poo" ).popup( "close" );  
		DS.showMore();
        e.preventDefault();
    });	
	$( "#expand" ).on( "click", function( e ){      
		DS.address.zip = '';
		DS.query.term = '';  
		$('#opt-zip').val('');
		DS.setSelect('#opt-category','all');
        $( "#poo" ).popup( "close" );  
		DS.showMore();
        e.preventDefault();
    });	
	$('.onchange').on( "change", function( e ){  
		DS.refresh_list();
		DS.address.city = $('#opt-city').val();
		DS.address.zip = $('#opt-zip').val();	
		DS.query.search = $('#s').val();
		if (DS.query.search != '') {
			var fetch = DS.listen('get_search_results',DS.query.search);
			DS.showMore(fetch);
		} else {
			DS.showMore();
		}	  
		e.preventDefault();
    });	
	$('#opt-category').on( "change", function( e ){
		DS.refresh_list();
		$('#s').val('');	
		DS.query.term = $('#opt-category').val();
		DS.query.term = (DS.query.term == 'all')? '' : DS.query.term;
		DS.showMore();
	});
	$('.submit-login').on( "click", function( e ){
		e.preventDefault();
		DS.login();
	});	
	$('.submit-register').on( "click", function( e ){
		e.preventDefault();
		var required = false;
		$('.reg-field').each(function() {
			var val = $(this).val();
			if(val === ''){	
				$(this).addClass( "error" );
				$('div.register-alert').html('Please Verify the below Fields.').show();		
				return false;
			} else {
				required = true;				
			}
		});
		if (required){
			var password = $('#pass-reg').val();	
			var conf = $('#pass-confirm').val();	
			if(password != conf){
						
			} else {
				DS.register();
			}
		}
		
	});
	DS.onDeviceReady();
});
$( document ).on( "pagecreate", "#single", function() {
	$( "#login" ).enhanceWithin().popup();
	DS.query.search = '';
	var stickyOffset = 40;
	$(document).on('scrollstart', function(){ 
		if ($(window).scrollTop() >= stickyOffset) $('#single-header h1').html(DS.post.title);
		else  $('#single-header h1').html('Dog Sniffer');
	});
	$(document).on('scrollstop', function(){ 
		if ($(window).scrollTop() >= stickyOffset) $('#single-header h1').html(DS.post.title);
		else  $('#single-header h1').html('Dog Sniffer');
	});    
    $( "#map-pop" ).on({
        popupbeforeposition: function() {
            var size = DS.scale( 480, 320, 0, 1 ),
                w = size.width,
                h = size.height;
            $( "#mage-dir" ).css( { "width" : w, "height" : h } );
			directions.refresh();
			directions.idle();
			directions.fitZoom();	
        },
        popupafterclose: function() {
            $( "#map-map" ).css( { "width" : 0, "height" : 0 } );
        }
    });
	$('.submit-rating').on( "click", function( e ){	
		e.preventDefault();
		DS.postReview();
	});	
	 $( '#review' ).on({
        popupafterclose: function() {
			if (DS.user.cookie === '') {
				setTimeout( function(){ $( '#login' ).popup( 'open' ) }, 100 );
			}
        }
    });
});
var DS = {
	address: {full:'',city:'Los Angeles',city_code: 'la', zip:'',state:'',street:'',county:''},
	supported: ['Los Angeles','Orange County','Santa Barbara'],
	query: {search: '',term: '',post_type: 'listing',count: 5,offset: 0,posts:[]},
	geo: {origin:[],lat:'',lng:''},
	single: {title:'',about:'',hours:'',website:''},
	user: {cookie:'',cookie_name:'',username:'',title:'',about:'',hours:'',website:''},
	cache: {review:'',rating:'',full:false},
	post: {id:'',category:'',reviews:'',},
	nearby: false,	
	setSelect: function(target, value){
		value = value || false;
		if (value) $(target).val(value).attr('selected', true).siblings('option').removeAttr('selected');
		$(target).selectmenu();
		$(target).selectmenu("refresh", true);
	},
	setUser: function(user){
		DS.user.cookie = user.cookie;
		DS.user.cookie_name = user.cookie_name;
		DS.user.data = user.user;
		$( "#welcome h3" ).html('Welcome Back, '+DS.user.data.displayname);
		$( "#welcome p" ).html('<img src="'+DS.user.data.avatar+'" class="thumbnail" />');
		$( "#welcome" ).popup( "open" );
		$(".login-button").remove();	
		$('.footer-nav').append('<li><a href="#profile" data-icon="user">Profile</a></li>');				
	},
	postReview: function(){
		DS.cache.review = $('#review_text').val() || '';
		DS.cache.rating = $('input[name*=rating]:checked').val() || '';
		if (DS.cache.review === ''){
			$('#review div.alert').html('Please add a short review summary.').show();
		} else if (DS.cache.rating === ''){
			$('#review div.alert').html('Please choose a rating.').show();
		} else if (DS.user.cookie === ''){
			$( "#review" ).popup( "close" );
			DS.cache.full = true;
			$('#login div.alert').html('You have to be Signed In to Submit a Review.').show();
		} else {
			var whistle = DS.listen('post_comment',DS.cache.review,DS.cache.rating) || '';
			DS.pauseInputs('Barking your Review');
		$.ajax({
			type: 'GET',
			url: whistle,
			dataType: 'json',
            success: function(response) {
				if (response.status !== 'ok'){
					$('div.review-alert').html(response.error).show();					
				} else {
				console.log(response);
				var rev = {rating: response.rating, review_count: response.count};		
				var average = DS.displayReview(rev,false,true);
				$('.entry-header .average-rating').html(average);
				var rating = DS.displayReview(DS.cache.rating,true);
				$( ".druid-reviews-title" ).show();
				$( ".druid-reviews").append('<li class="druid-list-item druid-review-item ui-li-has-thumb">' +'<img src="'+DS.user.data.avatar+'" class="avatar" />'+'<h4>'+DS.user.data.displayname+'</h4>'+ rating + DS.cache.review +'</li>');
				$( ".druid-reviews").listview( "refresh" ); 
				}
			},
			timeout: 10000,  // Timeout after 10 seconds
			error: function(jqXHR, textStatus, errorThrown) {
                console.log("Error, textStatus: " + textStatus + " errorThrown: "+ errorThrown);
				$.mobile.loading( "hide" );
				DS.onError(errorThrown);
           	}
		}).done(function() {
			DS.playInputs();
		});
		}
	},
	register: function(){		
		var password = $('#pass-reg').val();	
		var conf = $('#pass-confirm').val();	
		var nonce = DS.listen('get_nonce','user','register');	
		alert('URL: '+nonce);
		DS.pauseInputs('Joining the Pack');
		$.ajax({
			type: 'GET',
			url: nonce,
			dataType: 'json',
            success: function(first) {
				console.log(first);
				if (first.status !== 'ok'){
					$('div.register-alert').html(first.error).show();					
				} else {
					DS.user.username = $('#user-reg').val();
					var password = $('#pass-reg').val();	
					var email = $('#email-reg').val();	
					var register = DS.listen('register',first.nonce,DS.user.username, password,email);
					$.ajax({
						type: 'GET',
						url: register,
						dataType: 'json',
           				success: function(second) {
							console.log(second);
							if (second.status == 'ok'){		
							}
						},
						timeout: 10000,  // Timeout after 10 seconds
           				error: function(jqXHR, textStatus, errorThrown) {
                			console.log("Error, textStatus: " + textStatus + " errorThrown: "+ errorThrown);
							$.mobile.loading( "hide" );
							DS.onError(errorThrown);
           				}
					});
				}
			},
			timeout: 10000,  // Timeout after 10 seconds
            error: function(jqXHR, textStatus, errorThrown) {
                console.log("Error, textStatus: " + textStatus + " errorThrown: "+ errorThrown);
				$.mobile.loading( "hide" );
				DS.onError(errorThrown);
            }
		}).done(function() {
			DS.playInputs();
		});
		
	},
	login: function(){
	var nonce = DS.listen('get_nonce');
	DS.user.username = $('#user-field').val();
	var password = $('#pass-field').val();	
	DS.pauseInputs('Authenticating');
	if (nonce){
		$.ajax({
			type: 'GET',
			url: nonce,
			dataType: 'json',
            success: function(first) {
				if (first.status !== 'ok'){
					$('#login div.alert').html(first.error).show();					
				} else {
					var cookie = DS.listen('login',first.nonce,DS.user.username,password);
					$.ajax({
						type: 'GET',
						url: cookie,
						dataType: 'json',
           				success: function(user) {
							console.log(user);
							if (user.status == 'ok'){
								DS.setUser(user);
								DS.user.data = user.user;								
								$('.ui-btn-login').html('Profile').attr('href','#options').buttonMarkup({ icon: "user" });
								if (DS.cache.full === true){
									DS.postReview();
									DS.cache.full = false;
									$('#login .ui-content').html('<h3>Your Review Has been Submitted</h3>');
								} else {
									$('#login .ui-content').html('<h3>Welcome Back, '+DS.user.data.displayname+'</h3><img src="'+DS.user.data.avatar+'" class="thumbnail" />');
								}
								
								
							} else {
								$('#login div.alert').html(user.error).show();
								$('#user-field').val('');
								$('#pass-field').val('');
							}
						},
						timeout: 10000,  // Timeout after 10 seconds
           				error: function(jqXHR, textStatus, errorThrown) {
                			console.log("Error, textStatus: " + textStatus + " errorThrown: "+ errorThrown);
							$.mobile.loading( "hide" );
							DS.onError(errorThrown);
           				}
					});
				}
			},
			timeout: 10000,  // Timeout after 10 seconds
            error: function(jqXHR, textStatus, errorThrown) {
                console.log("Error, textStatus: " + textStatus + " errorThrown: "+ errorThrown);
				$.mobile.loading( "hide" );
				DS.onError(errorThrown);
            }
		}).done(function() {
			DS.playInputs();
		});
	}
	},
	onError: function(text){
		text = text || 'An Error Has Occured';
		$( "#error p" ).html(text);
		$( "#error" ).popup( "open" );  
	},
	refresh_list: function (){
		$('.druid-list-item').remove();
		DS.query.posts = [];
		DS.query.offset = 0;
	},
	listen: function(method,value,value2,value3,value4){
		var url = 'http://dogsniffer.com/'+DS.address.city_code+'/api/';
		method = method || 'get_posts';
		if (method == 'get_posts'){			
			url += method+'/?count='+DS.query.count+'&offset='+DS.query.offset;
			if (DS.address.zip !== '') url += '&meta_key=mage_zip&meta_value='+DS.address.zip;
			if (DS.query.term !== '') url += '&type='+DS.query.term;
			//if (DS.query.search !== '') url += '&s='+DS.query.search;
		}
		if (method == 'get_category_posts'){			
			url += 'get_posts/?count='+value2+'&type='+value+'&exclude='+DS.post.id;			
		}
		if (method == 'get_post'){
			url += method+'/?id='+value;
		}
		if (method == 'get_nonce'){
			value = value || 'auth';
			value2 = value2 || 'generate_auth_cookie';
			url += method+'/?controller='+value+'&method='+value2;
			return url;
		}
		if (method == 'login'){
			url += 'auth/generate_auth_cookie/?nonce='+value+'&username='+value2+'&password='+value3;
			return url;
		}
		if (method == 'register'){
			url += 'user/'+method+'/?username='+value2+'&email='+value4+'&nonce='+value+'&display_name='+value2+'&user_pass='+value3+'&notify=no';
			return url;
		}
		if (method == 'get_search_results'){
			url += method+'/?search='+value;
		}
		if (method == 'post_comment'){
			var cookie = DS.user.cookie;
			var id = DS.post.id;
			if (cookie === '' || id === '') return false;
			url += 'user/'+method+'/?cookie='+cookie+'&post_id='+id+'&content='+value+'&comment_status=1&rating='+value2;
			return url;
		}
		if (DS.query.post_type !== ''){
			url += '&post_type='+DS.query.post_type;
		}
		console.log(url);
		return url;	
	},
	singleView: function(singleID){
		var bark = DS.listen('get_post',singleID);
		$.ajax({
		type: 'GET',
		url: bark,
		dataType: 'json',
      	success: function( value ) {		
			console.log(value);	
			value = value.post;
			GMaps.geocode({
			address: value.listing.street+', '+value.listing.city+', '+value.listing.zip,
			callback: function(results, status) {
				if (status == 'OK') {
					var latlng = results[0].geometry.location;
					url = GMaps.staticMapURL({
						size: [800, 180],
						lat: latlng.lat(),
						lng: latlng.lng(),
						markers: [{lat: latlng.lat(),lng: latlng.lng()}]
					});
					
					if (DS.nearby === false){
						DS.geo.lat = 34.0544902;
						DS.geo.lng = -118.4413104;
						DS.nearby = true;
					}
					DS.geo.origin = [DS.geo.lat,DS.geo.lng];
					
					if (DS.nearby){
					directions = new GMaps({
						div: '#mage-dir',
						lat: latlng.lat(),
						lng: latlng.lat(),
						disableDefaultUI: true,
						zoom: 12,
						//height: '320px',
						//width: '480px',
						idle: function(){
							directions.refresh();
						},
						resize: function(){
							var center = directions.getCenter();
							directions.setCenter(center.lat(), center.lng());
						}
					});					
					directions.addMarker({
						lat: DS.geo.lat,
						lng: DS.geo.lng,
						infoWindow: {
								content: '<h4>You are here.</h4>'
						},
						icon: 'img/origin.png'
					});
					directions.addMarker({
						lat: latlng.lat(),
						lng: latlng.lng()
					});
					directions.fitZoom();		
					directions.drawRoute({
						origin: DS.geo.origin,
						destination: [latlng.lat(), latlng.lng()],
                        travelMode: 'driving',
                        strokeColor: '#131540',
                        strokeOpacity: 0.6,
                        strokeWeight: 6
					});					
					var distance = 0;
					var time = 0;
					directions.getRoutes({
						origin: DS.geo.origin,
						destination: [latlng.lat(), latlng.lng()],
						callback: function (e) {
						console.log(e);
						
                            for (var i=0; i<e[0].legs.length; i++) {
								time += e[0].legs[i].duration.value;
								distance += e[0].legs[i].distance.value;
                            }
							time = Math.round(time / 60);
							distance = (Math.ceil( distance * 0.62137 ) / 1000).toFixed(1);
							$(".dist").append('<div class="dist-time">'+time+' min</div>'+distance+' miles');
                        }
					});
					} else {
						$('.page-directions').remove();
					}
					$(".mapbox").css('background-image','url('+url+')');
					$(".map-add").append(value.listing.street+'<br />'+value.listing.city+', '+value.listing.zip);
				}
			}
			});	
			DS.post.title = value.title;			
			var reviews = DS.displayReview(value.rating);	
			var cat = category = hours = openDay = website = theTime = '';
			if (value.types.children.length !== 0) {
				DS.post.category = cat = value.types.children[0].slug;
				category = '<p class="category">'+value.types.children[0].name+'</p>';
			}				
			if (value.cast !== undefined){
			var today = new Date();
			var weekdays = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
			var weekday = weekdays[today.getDay()];
			$.each({'Monday':'mon','Tuesday':'tue','Wednesday':'wed','Thursday':'thu','Friday':'fri','Saturday':'sat','Sunday':'sun'}, function(day,hour){
				theTime = value.cast['mage_'+hour+'-from'] || '';	
				if (theTime !== ''){ 
					hours += '<strong>'+day+':</strong> '+value.cast['mage_'+hour+'-from']+' - '+value.cast['mage_'+hour+'-to']+'<br />';
					if (weekday === day) openDay = '<div class="today">Hours Today: '+value.cast['mage_'+hour+'-from']+' - '+value.cast['mage_'+hour+'-to']+'</div>';
				} else {
				
				
				}
			});
			var website = value.cast['mage_url'];
			if (hours !== '') $("#listing-more").append('<li data-role="list-divider">Hours</li><li>'+hours+'</li>');
			if (website !== '') $("#listing-more").append('<li data-role="list-divider">Website</li><li><a href="#" onclick="window.open(\'http://'+website+'\', \'_system\');">'+website+'</a></li>');
			}	
			$(".entry-header").append('<h2>'+value.title+'</h2>'+reviews+openDay+category);	
			$("#listing-about").append('<h2>About</h2><p>'+value.content+'</p>');
			$("#listing-more").append('<li data-role="list-divider">About</li><li>'+value.content+'</li>').listview( "refresh" );
			$("#tel a").attr("href", 'tel:'+value.listing.phone).append(' '+value.listing.phone);		
			DS.post.reviews = value.reviews;
			DS.showRelated(DS.post.category);
			DS.showReviews(DS.post.reviews);  
            },
            timeout: 6000,  // Timeout after 6 seconds
            error: function(jqXHR, textStatus, errorThrown) {
                console.log("Error, textStatus: " + textStatus + " errorThrown: "+ errorThrown);                
            }
        });
		
	},	
	pauseInputs: function (text){
		$('#opt-category').selectmenu('disable');
		$('#open-map').flipswitch( "disable" );
		$('button, ul li a.ui-btn').attr('disabled','disabled');
		$('a.ui-btn').addClass('ui-disabled');
		$('input[type="text"], input[type="search"]').attr('disabled','disabled');
		text = text || 'Sniffing Out Locations Near You';
		if (DS.address.zip !== '') text = 'Sniffing Out Locations Near '+DS.address.zip;
		$.mobile.loading( "show", {
			text: text,
			textVisible: true,
			theme: 'z',
			html: ""
		});	
	},
	playInputs: function (){
		$('#opt-category').selectmenu('enable');
		$('#open-map').flipswitch( "enable" );
		$('button, ul li a.ui-btn').removeAttr('disabled','disabled');
		$('a.ui-btn').removeClass('ui-disabled');
		$('input[type="text"], input[type="search"]').removeAttr('disabled','disabled');
		$.mobile.loading( "hide" );
	},
	displayReview: function(rating,single,count){
		rating = rating || '';
		if (rating === '') return '';
		single = single || false;
		count = count || false;
		if (single) {
			rating = rating*100/5;
			return '<div class="single-rating"><div class="author-rating"><span style="width:'+rating+'%;"></span></div></div>';
		}
		var num = rating.review_count;
		var reviews = '';
		if (num > 1){
			reviews += ' <div class="review-count">'+num+' reviews</div>';
		} else if (num == 1){
			reviews += '<div class="review-count">'+num+' review</div>';
		}
		if (count) return '<div class="author-rating"><span style="width:'+rating.rating+'%;"></span></div>'+reviews;
		return '<div class="average-rating"><div class="author-rating"><span style="width:'+rating.rating+'%;"></span></div>'+reviews+'</div>';
	},
	displayImage: function(thumb){
		thumb = thumb || 'http://dogsniffer.com/wp-content/themes/Gryphon/mage/images/dining.png';
		return '<img src="'+thumb+'" class="thumbnail" />';
	},
    showMore: function(whistle) {
		whistle = whistle || DS.listen();
		DS.pauseInputs();
        $.ajax({
			type: 'GET',
			url: whistle,
			dataType: 'json',
            success: function( response ) {
				var sniffed = '';
        		$.each(response.posts, function(index, value) {
					DS.query.posts.push(value);
					DS.query.offset += 1;
					console.log(value);	
					var reviews = DS.displayReview(value.rating);
					var img = DS.displayImage(value.thumbnail);
					var cat = (value.types.children.length !== 0)? '<p class="item-cat">'+value.types.children[0].name+'</p>': '';

					
					sniffed += '<li class="druid-list-item ui-li-has-thumb item-'+value.type+'">' +
			      	'<a href="single.html?id='+value.id+'" class="ui-btn ui-btn-icon-right ui-icon-carat-r">' + img +'<h2>'+value.title+'</h2>';
					sniffed += reviews;
					sniffed += '<p class="item-address">'+value.listing.street+', '+value.listing.city+'</p>';
					sniffed += cat;
					sniffed += '</a></li>';
				});
				if(sniffed !== ''){
               		$( ".druid-listings" ).find( "#show-more" ).before(sniffed);
                	$( ".druid-listings" ).listview( "refresh" );
				} else {
				var message = 'We couldn\'t sniff out any listings with the criteria:';
					if (DS.query.search !== '') message += '<p>Keyword: <span style="color:#dd3333">'+DS.query.search+'</span></p>';
					if (DS.address.zip !== '') message += '<p>Zip Code: <span style="color:#dd3333">'+DS.address.zip+'</span></p>';
					if (DS.query.term !== '') message += '<p>Category: <span style="color:#dd3333">'+DS.query.term+'</span></p>';
					$( "#poo h3.ui-title" ).html(message);
					$( "#poo" ).popup( "open" );  
				}
            },
            timeout: 10000,  // Timeout after 10 seconds
            error: function(jqXHR, textStatus, errorThrown) {
                console.log("Error, textStatus: " + textStatus + " errorThrown: "+ errorThrown);              
            }			
        }).done(function() {
			DS.playInputs();
		});
    },
	queryMap: function(query){
		$.each(query, function(index, value) {
			GMaps.geocode({
				address: value.listing.street+', '+value.listing.city+', '+value.listing.zip,
				callback: function(results, status) {
					if (status == 'OK') {
						var latlng = results[0].geometry.location;		
						map.setCenter(latlng.lat(), latlng.lng());								
						map.addMarker({
							title:  value.title,
							lat: latlng.lat(),
							lng: latlng.lng(),
							infoWindow: {
								content: '<h2>'+value.title+'</h2>'+'<a href="tel:'+value.listing.phone+'" class="ui-btn ui-btn-icon-right ui-icon-phone">'+value.listing.phone+'</a><a href="single.html?id='+value.id+'" class="ui-btn ui-btn-icon-right ui-icon-carat-r">View Listing</a>'
							}
							//icon: "http://dogsniffer.com/wp-content/uploads/2013/03/favicon.png"
						});
						map.fitZoom();									
					}
				}
			});	
		});
	},
    showRelated: function(cat) {
		if (cat === '') return '';
		var whistle = DS.listen('get_category_posts',cat,3); 
		console.log('Related:'+whistle);
        $.ajax({
			type: 'GET',
			url: whistle,
			dataType: 'json',
            success: function( related ) {
				var sniffed = '';		
				console.log(related);
        		$.each(related.posts, function(index, value) {
					if (value.id != DS.post.id){
					var reviews = DS.displayReview(value.rating);
					var img = DS.displayImage(value.thumbnail);
					var cat = (value.types.children.length !== 0)? '<p>'+value.types.children[0].name+'</p>': '';
					sniffed += '<li class="druid-list-item ui-li-has-thumb item-'+value.type+'">' +
			      	'<a href="single.html?id='+value.ID+'" class="ui-btn ui-btn-icon-right ui-icon-carat-r">' + img +'<h4>'+value.title+'</h4>' + reviews +
					'<p><strong>'+value.listing.street+', '+value.listing.city+'</strong></p>' + cat + '</a></li>';
					}
				 });
				if (sniffed !== ''){
                	$( ".druid-related" ).append(sniffed);
               		$( ".druid-related" ).listview( "refresh" );
				} else {
					$( ".druid-related-block" ).remove();
				}                
            },
            timeout: 10000,  // Timeout after 10 seconds
            error: function(jqXHR, textStatus, errorThrown) {
                console.log("Error, textStatus: " + textStatus + " errorThrown: "+ errorThrown);                
            }
        });
    },
	showReviews: function(reviews) {
     	var sniffed = '';	
        $.each(reviews, function(index, value) {
			console.log(value);
			var img = value.avatar;
			var name = value.author;
			var review = value.data.comment_content;						
			rating = DS.displayReview(value.rating,true);
			sniffed += '<li class="druid-list-item druid-review-item ui-li-has-thumb">' +img+'<h4>'+name+'</h4>'+ rating + review +'</li>';
		});
		if (sniffed !== ''){
			$( ".druid-reviews").append(sniffed);
			$( ".druid-reviews").listview( "refresh" ); 
		} else {
			$( ".druid-reviews-title" ).hide();
		}
    },
	onDeviceReady: function() {
		navigator.geolocation.getCurrentPosition(DS.onSuccess, DS.onError);     
	},
	onSuccess: function(position) {
	var city = DS.address.city;
	var lat = position.coords.latitude;
	var lng = position.coords.longitude;
	var latlng = new google.maps.LatLng(lat, lng);
	DS.geo.lat = lat;
	DS.geo.lng = lng;
	DS.geo.origin = [lat, lng];	
	geocoder = new google.maps.Geocoder();
	geocoder.geocode({'latLng': latlng}, function(results, status) {
			console.log(results);
			if (status == google.maps.GeocoderStatus.OK) {		
				DS.address.full = results[0].formatted_address;				
				if (results[1]) {				
					for (var i=0; i<results[0].address_components.length; i++) {
						for (var b=0;b<results[0].address_components[i].types.length;b++) {		
							if (results[0].address_components[i].types[b] == "administrative_area_level_1") {
								city = results[0].address_components[i];															
								if ($.inArray(city.long_name, DS.supported) !== -1){
									DS.address.city = city.long_name;	
									if (DS.address.city == 'Santa Barbara'){
										DS.address.city_code = 'sb';
									} else if (DS.address.city == 'San Francisco') {
										DS.address.city_code = 'sf';
									} else if (DS.address.city == 'Orange County') {
										DS.address.city_code = 'oc';
									}									
								} else {
									break;
								}
							}
							if (results[0].address_components[i].types[b] == "postal_code") {
								DS.address.zip = results[0].address_components[i].long_name;	
								DS.nearby = true;
								$('#opt-zip').val(DS.address.zip);	
								$('#opt-add').val(DS.address.full);	
								break;
							}
						}
					}				
				} 			
				DS.setSelect('#opt-city',DS.address.city_code);				
				DS.showMore();		
			} else {
				alert("Geocoder failed due to: " + status);
			}
		});
	},
	scale: function( width, height, padding, border ){
	 // The window width and height are decreased by 30 to take the tolerance of 15 pixels at each side into account
        var scrWidth = $( window ).width() - 30,
            scrHeight = $( window ).height() - 30,
            ifrPadding = 2 * padding,
            ifrBorder = 2 * border,
            ifrWidth = width + ifrPadding + ifrBorder,
            ifrHeight = height + ifrPadding + ifrBorder,
            h, w;
        if ( ifrWidth < scrWidth && ifrHeight < scrHeight ) {
            w = ifrWidth;
            h = ifrHeight;
        } else if ( ( ifrWidth / scrWidth ) > ( ifrHeight / scrHeight ) ) {
            w = scrWidth;
            h = ( scrWidth / ifrWidth ) * ifrHeight;
        } else {
            h = scrHeight;
            w = ( scrHeight / ifrHeight ) * ifrWidth;
        }
        return {
            'width': w - ( ifrPadding + ifrBorder ),
            'height': h - ( ifrPadding + ifrBorder )
        }
    }	
};
	</script>
    </head>
    <body>
	<div data-role="page" id="home" class="page">
	<div data-role="header" data-position="fixed"><h1>Dog Sniffer</h1>
	<form id="flippos">
		<select name="open-map" id="open-map" data-role="flipswitch" data-theme="b" data-corners="false">
		<option value="list">List</option>
		<option value="map" selected="">Map</option>
		</select></form>
	</div>
	<div id="mage-list" role="main" class="ui-content">
	<input type="search" placeholder="Zip Code" id="opt-zip" name="opt-zip" value="" data-clear-btn="true" class="onchange" data-theme="a" />
	<input type="search" placeholder="Sniff For" id="s" name="s" value="" data-clear-btn="true" class="onchange" data-theme="a" />
	<select name="opt-category" id="opt-category" data-native-menu="false" class="mage-select"><option data-placeholder="true">Categories</option>
		<option value="all">All Categories</option>
		<option value="activities">Activities</option>
		<option value="dining">Dining</option>
		<option value="health-care">Health & Care</option>
		<option value="services">Services</option>
		<option value="shopping">Shopping</option>
		<option value="training">Training</option>
		<option value="travel">Travel</option>
    </select>
	<ul class="druid-listings ui-corner-all ui-shadow" data-role="listview" data-inset="true">
		<li id="show-more" data-theme="b" data-icon="plus" ><a href=""><h1>Show more</h1></a></li>
	</ul>
	</div>
	<div role="main" class="ui-content" id="mage-map" style="display:none;"></div>
	<div data-role="footer" data-position="fixed" role="contentinfo">			
		<div data-role="navbar">
		<ul><li><a href="#" data-icon="home" class="ui-btn-active ui-btn">Nearby</a></li>
			<li><a href="#login"  data-rel="popup" data-icon="lock"  data-position-to="window" class="ui-btn ui-shadow ui-btn-inline ui-icon-lock ui-btn-login" data-transition="pop">Sign In</a></li>		
			<li><a href="#actions"  data-rel="popup" data-icon="bars" class="ui-btn ui-shadow ui-btn-inline ui-icon-bars" data-transition="slideup">Options</a></li>					
		</ul>
		</div>
	</div>
	<div data-role="panel" id="options" data-position="left" data-position-fixed="false" data-display="overlay">
		<h3>Search Options</h3>
		<select name="opt-city" id="opt-city" data-native-menu="false" class="onchange mage-select">
			<option>Choose A City</option>
			<option value="la">Los Angeles</option>
			<option value="sb">Santa Barbara</option>
			<option value="oc">Orange County</option>
		</select>		
	</div>
	<div data-role="popup" id="error">
		<div role="main" class="ui-content">
			<h3 class="ui-title"></h3>
			<p></p>
		</div>
	</div>
	<div data-role="popup" id="poo">
		<a href="#" data-rel="back" data-theme="b" class="ui-btn ui-btn-b ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>
		<div data-role="header" data-theme="a"><h1>Oh Dog Poo!</h1></div>
		<div role="main" class="ui-content">
			<h3 class="ui-title"></h3>
			<a href="#" id="expand" data-role="button" class="ui-btn ui-corner-all ui-shadow ui-btn-icon-left ui-btn-inline ui-icon-recycle"  data-icon="recycle">Expand Search</a>
			<a href="#" id="research" data-role="button" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-icon-left ui-icon-delete" data-icon="delete">Clear All</a>
		</div>
	</div>		
	</div>
	<div data-role="popup" id="actions" data-theme="b">
			<ul data-role="listview" data-inset="true" style="min-width:210px;">
			<li data-role="list-divider">Options</li>
			<!--<li><a href="profile.html">Profile</a></li>
			<li><a href="new.html">Add Listing</a></li>
			<li><a href="#">My Listing</a></li>
			<li><a href="#">Favourites</a></li>-->
			<li><a href="#options" data-role="button">Change City</a></li>
			<li><a href="#" onclick="window.open('http://www.dogsniffer.com', '_system');">Browser App</a></li>
			</ul>
		</div>
	<div data-role="popup" id="login" data-theme="a" class="ui-corner-all" style="min-width:300px;">
		<div data-role="header" data-theme="a"><h1>Login</h1></div>
		
		<div role="main" class="ui-content" style="padding:10px 20px;">
			<form id="login-form">
			<div class="alert alert-red login-alert" style="display:none;"></div>
			<div class="user-block">
			<label for="un" class="ui-hidden-accessible">Username:</label>
			<input type="text" placeholder="Username" id="user-field" name="user-field" value="" data-theme="a">
			<label for="pw" class="ui-hidden-accessible">Password:</label>
			<input type="password" placeholder="Password" id="pass-field" name="pass-field" value="" data-theme="a">
			<button type="submit" class="ui-btn ui-corner-all ui-shadow ui-btn-b ui-btn-icon-left ui-icon-check submit-login">Sign in</button>
			</div>	
			<h3>Don't Have an Account? No Problem!</h3>			
			<a href="#" data-icon="user" id="open-register" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-user ui-btn-icon-left">Sign Up</a>				
			<a href="#" data-icon="info" id="open-password" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-info ui-btn-icon-right" data-transition="pop">Forgot Password?</a>		
			</form>
			<form id="register-form" style="display:none;">
			<div class="alert alert-red register-alert" style="display:none;"></div>
			<div class="user-block">
			<label for="user-field" class="ui-hidden-accessible">Username:</label>
			<input type="text" class="reg-field" placeholder="Username" id="user-reg" name="user-reg" value="" data-theme="a">
			<label for="user-email" class="ui-hidden-accessible">E-mail:</label>
			<input type="email" class="reg-field" placeholder="E-mail" id="email-reg" name="email-reg" value="" data-theme="a">
			<label for="pw" class="ui-hidden-accessible">Password:</label>
			<input type="password" class="reg-field" placeholder="Password" id="pass-reg" name="pass-reg" value="" data-theme="a">
			<label for="pw" class="ui-hidden-accessible">Confirm Password:</label>
			<input type="password" class="reg-field" placeholder="Confirm Password" id="pass-confirm" name="pass-confirm" value="" data-theme="a">
			<button type="submit" class="ui-btn ui-corner-all ui-shadow ui-btn-b ui-btn-icon-left ui-icon-check submit-register">Sign Up</button>
			</div>	
			<h3>Already have an Account?</h3>			
			<a href="#" id="open-login" data-icon="user" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-user ui-btn-icon-left">Sign In</a>
			</form>				
		</div>		
	</div>
    </body>
</html>